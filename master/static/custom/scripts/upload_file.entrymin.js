var SEL_FLASH_FIRMWARE_DEV=[],CreateFirmwareTableModel=function(){var a,b=$("#node_id").html(),c=$("#device_ids").html(),d=$("#current_user_id").html(),e={};e.NodeID=b,e.CurrentUserID=d,"[]"==c?e.DeviceIDs="":e.DeviceIDs=c;var f=$("#flash_device_manage_table"),g=function(b){return a=f.dataTable({language:{sProcessing:"处理中...",sLengthMenu:"每页显示_MENU_项结果",sZeroRecords:"没有匹配结果",sInfo:"显示第_START_至_END_项结果，共_TOTAL_项",sInfoEmpty:"显示第0至0项结果，共0项",sInfoFiltered:"(由_MAX_项结果过滤)",sInfoPostFix:"",sSearch:"搜索:",sUrl:"",sEmptyTable:"表中数据为空",sLoadingRecords:"载入中...",sInfoThousands:",",oPaginate:{sFirst:"首页",sPrevious:"上页",sNext:"下页",sLast:"末页"},oAria:{sSortAscending:":以升序排列此列",sSortDescending:":以降序排列此列"}},buttons:[],dom:"<'row' <'col-md-12'B>><'row'<'col-md-6 col-sm-12'l><'col-md-6 col-sm-12'f>r><'table-scrollable't><'row'<'col-md-5 col-sm-12'i><'col-md-7 col-sm-12'p>>",bStateSave:!1,bAutoWidth:!1,lengthMenu:[[20,30,100,-1],[20,30,100,"All"]],pageLength:20,pagingType:"bootstrap_full_number",order:[[1,"asc"]],ajax:{type:"POST",url:b,dataSrc:"",data:e},columnDefs:[{targets:0,orderable:!1,searchable:!0,sClass:"dt-body-center",data:"Check"},{targets:1,orderable:!0,searchable:!0,sClass:"dt-body-center",data:"number"},{targets:2,orderable:!0,searchable:!0,sClass:"dt-body-center",data:"LineNum"},{targets:3,orderable:!0,searchable:!0,data:"Firmware"},{targets:4,data:"FlashConfig"},{targets:5,data:"ProgressBar"},{targets:6,data:"FlashDetail"}],drawCallback:function(a){App.initUniform($('input[type="checkbox"]',f))}}),f.find(".group-checkable").change(function(){var b=jQuery(this).attr("data-set"),c=jQuery(this).is(":checked"),d=a.fnGetNodes();if(SEL_FLASH_FIRMWARE_DEV=[],jQuery(b).each(function(a){c?($(this).prop("checked",!0),$(this).parents("tr").addClass("active")):($(this).prop("checked",!1),$(this).parents("tr").removeClass("active"))}),c)for(var e=0,f=d.length;e<f;e++)if(d[e].className.includes("active")){var g=a.fnGetData(d[e]);SEL_FLASH_FIRMWARE_DEV.indexOf(g.DeviceID)==-1&&SEL_FLASH_FIRMWARE_DEV.push(g.DeviceID)}jQuery.uniform.update(b)}),f.on("change","tbody tr .checkboxes",function(){var b=($("#flash_device_manage_table").DataTable(),$(this).parents("tr")[0]),c=a.fnGetData(b);if($(this).parents("tr").toggleClass("active"),$(b).hasClass("active"))SEL_FLASH_FIRMWARE_DEV.indexOf(c.DeviceID)==-1&&SEL_FLASH_FIRMWARE_DEV.push(c.DeviceID);else{var d=SEL_FLASH_FIRMWARE_DEV.indexOf(c.DeviceID);SEL_FLASH_FIRMWARE_DEV.remove(d)}}),f.on("click","tbody tr td",function(b){var c=$("#flash_device_manage_table").DataTable(),d=c.cell(this).index().column;if(!$(this).find(".checkboxes").is(":checkbox")&&3!==d&&4!==d){var e=$(this).parents("tr")[0],f=a.fnGetData(e),g=$(this).parents("tr").find(".checkboxes"),h=g.is(":checked");if(h?jQuery.uniform.update(g.prop("checked",!1)):jQuery.uniform.update(g.prop("checked",!0)),$(this).parents("tr").toggleClass("active"),$(e).hasClass("active"))SEL_FLASH_FIRMWARE_DEV.indexOf(f.DeviceID)==-1&&SEL_FLASH_FIRMWARE_DEV.push(f.DeviceID);else{var i=SEL_FLASH_FIRMWARE_DEV.indexOf(f.DeviceID);SEL_FLASH_FIRMWARE_DEV.remove(i)}}}),f};return{init:function(a){return g(a)}}}(),FlashDeviceWizard=function(){var a=null,b=$("#flash_dev_wizard"),c=!1,d=$("#submit_form"),e=$(".alert-danger",d),f=function(a){e.hide()};Array.prototype.remove_item_by_value=function(a){var b=this.indexOf(a);b>-1&&this.splice(b,1)};var g=function(a,b){var c=parseInt(b),d="#"+String(a);$(d).pulsate({color:"#399bc3",repeat:c})},h=function(a){return{Firmware:a.find("option:selected").val(),FlashConfig:function(){for(var b=a.find("input[type='checkbox']:checked"),c=[],d=0,e=b.length;d<e;d++)"格式化"==b[d].value?c.push("format"):"重启"==b[d]&&c.push("restart");return c}()}},i=function(d,e,f){for(var g=0,h=0,i=0,j=d.length;i<j;i++){var k=d[i],l=$("."+k.DeviceID+"[class*=progress-bar]"),m=$("span[class*="+k.DeviceID+"]");l.attr("style","width:"+k.Progress+"%");var n=$(":checkbox[class*="+k.DeviceID+"]");l.attr("class").includes("progress-bar-success")?(l.parent().addClass("active"),l.removeClass("progress-bar-success"),l.addClass("progress-bar-info"),m.html(""),m.removeClass("label label-sm label-success")):(m.html(""),m.removeClass("label label-sm label-danger"),m.removeClass("label label-sm label-info")),f>=SEL_FLASH_FIRMWARE_DEV.length&&(e.socket.close(),c=!1,$("#btn_exec_flash").removeAttr("disabled"),b.find(".button-previous").show()),0==k.Progress?(m.addClass("label label-sm label-info"),m.html("烧写参数初始化中")):(m.removeClass("label label-sm label-info"),m.html("")),"DEV_UNAVAILABLE"in k&&(m.addClass("label label-sm label-danger"),m.html(k.DEV_UNAVAILABLE),f+=1,h+=1),k.Progress>=100&&(l.parent().removeClass("active"),l.removeClass("progress-bar-info"),l.addClass("progress-bar-success"),g+=1,m.addClass("label label-sm label-success"),m.html("烧写成功"),n.is(":checked")&&n.click(),SEL_FLASH_FIRMWARE_DEV.remove_item_by_value(k.DeviceID)),g+h>=d.length&&(e.socket.close(),c=!1,$("#btn_exec_flash").removeAttr("disabled"),b.find(".button-previous").show(),0==f&&"checked"==$("#th_checkboxes").find("span").attr("class")&&a.find(".group-checkable").click())}return f};InitSelFirmware=function(){var a=function(a,b){b.preventDefault();for(var c=a.selectedIndex,d=0;d<b.originalEvent.wheelDelta;d+=120)c--;for(var d=0;d>b.originalEvent.wheelDelta;d-=120)c++;c=Math.max(c,0),c=Math.min(c,a.children.length-1),a.selectedIndex=c};setTimeout(function(){$(".sel_firmware").on("mousewheel","",function(b){a(this,b)})},1e3)},ClearSelDev=function(){"checked"==$("#th_checkboxes").find("span").attr("class")&&(a&&a.find(".group-checkable").click(),sel_device=[])},InitFlashFirmwareTable=function(){var b=$("input[name='固件方式']:checked").val(),c="/load_flash_firmware_dev?Firmware_Method="+b;a?(a.api().ajax.url(c).load(),SEL_FLASH_FIRMWARE_DEV=[]):App.isAngularJsApp()===!1&&jQuery(document).ready(function(){a=CreateFirmwareTableModel.init(c)})};var j=function(){var d=function(a,c,d){var e=c.find("li").length,f=d+1;$(".step-title",b).text("第 "+(d+1)+" 步 "),jQuery("li",b).removeClass("done");for(var g=c.find("li"),h=0;h<d;h++)jQuery(g[h]).addClass("done");1==f?b.find(".button-previous").hide():b.find(".button-previous").show(),f>=e?(b.find(".button-next").hide(),b.find(".button-submit").show()):(b.find(".button-next").show(),b.find(".button-submit").hide()),App.scrollTo($(".page-title"))},e=function(){window.setTimeout(function(){if($("#flash_device_manage_table").find("select")[0]){$("#sel_firmware").html($("#flash_device_manage_table").find("select")[0].innerHTML);var a=function(a,b){b.preventDefault();for(var c=a.selectedIndex,d=0;d<b.originalEvent.wheelDelta;d+=120)c--;for(var d=0;d>b.originalEvent.wheelDelta;d-=120)c++;return c=Math.max(c,0),c=Math.min(c,a.children.length-1),a.selectedIndex=c,c};$("#sel_firmware").on("mousewheel","",function(b){for(var c=a(this,b),d=$(".sel_firmware"),e=0,f=d.length;e<f;e++)d[e].selectedIndex=c}),$("#sel_firmware").on("change","",function(a){for(var b=this.selectedIndex,c=$(".sel_firmware"),d=0,e=c.length;d<e;d++)c[d].selectedIndex=b})}},500)},j=function(b,c,d){var e=$("input[name='固件方式']:checked").val();$.ajax({type:"post",url:"/check_user_firmware",data:{Firmware_Method:e,CurrentUserID:$("#current_user_id").html()},error:function(a){hiAlert("云测系统出现问题，请联系管理员","提示")},success:function(b){""!=b?(hiAlert(b,"提示"),a&&a.fnClearTable()):(InitFlashFirmwareTable(),InitSelFirmware())}})};$("#btn_firmware_del").on("click","",function(a){var b=$("input[name='del_firmware_method']:checked").val(),c="method_1"==b?"确认删除今天上传过的固件吗？":"确认删除之前上传过的所有固件吗？",d=this;hiConfirm(c,"确认",function(a){a!==!1&&void 0!==a&&($(this).attr("disabled","true"),$.ajax({type:"post",url:"/del_user_firmware",data:{Del_Method:b,CurrentUserID:$("#current_user_id").html()},error:function(a){hiAlert("云测系统出现问题，请联系管理员 错误码："+a.status,"提示"),$(d).removeAttr("disabled")},success:function(a){""!==a&&hiAlert(a,"提示"),$(d).removeAttr("disabled")}}))})}),b.bootstrapWizard({nextSelector:".button-next",previousSelector:".button-previous",onTabClick:function(a,b,h,i){if(f(),c)return!1;if(0==i)$("#switch_display_portlet").attr("style","display:block"),ClearSelDev();else{if($("#switch_display_portlet").attr("style","display:none"),$("#fileupload > table")[0].rows.length>1)return hiAlert("还有上传固件等待处理，请点击开始上传或者清空添加文件按钮，然后继续操作","提示"),g("clear_file",5),!1;j(a,b,i),e()}d(a,b,i)},onNext:function(a,b,c){return f(),$("#fileupload > table")[0].rows.length>1?(hiAlert("还有上传固件等待处理，请点击开始上传或者清空添加文件按钮，然后继续操作","提示"),g("clear_file",5),!1):($("#switch_display_portlet").attr("style","display:none"),j(),e(),void d(a,b,c))},onPrevious:function(a,b,e){return f(),d(a,b,e),!c&&($("#switch_display_portlet").attr("style","display:block"),void ClearSelDev())},onTabShow:function(a,c,d){var e=c.find("li").length,f=d+1,g=f/e*100;b.find(".progress-bar").css({width:g+"%"})}}),b.find(".button-previous").hide(),b.find(".button-submit").hide(),$("#flash_dev_wizard .button-submit").click(function(){if($(this).attr("disabled"))return!1;if(0==SEL_FLASH_FIRMWARE_DEV.length)return hiAlert("请勾选设备","提示"),!1;for(var d=a.fnGetNodes(),e={},f=0,g=d.length;f<g;f++){var j=a.fnGetData(d[f]);SEL_FLASH_FIRMWARE_DEV.includes(j.DeviceID)&&(e[j.DeviceID]=h($($("."+j.DeviceID))),e[j.DeviceID].Number=j.number,e[j.DeviceID].LineNum=j.LineNum,e[j.DeviceID].AdbSerial=j.AdbSerial,e[j.DeviceID].ComNum=j.ComNum,e[j.DeviceID].NodeID=j.NodeID)}var k={};k.NodeID=$("#node_id").html(),App.startPageLoading({message:"正在初始化烧写参数，请稍后..."}),$.ajax({type:"post",url:"check_flash_firmware",data:k,error:function(a){hiAlert("云测系统出现问题，请联系管理员","提示"),App.stopPageLoading()},success:function(a){"Fail"==a?(App.stopPageLoading(),hiAlert("测试节点正被占用，请稍后再刷机","提示")):(App.stopPageLoading(),exec_flash_firmware())}}),exec_flash_firmware=function(){c||hiConfirm("固件烧写即将开始执行！点击取消则放弃执行。","确认",function(a){if(a===!1||void 0===a)return void(c=!1);c=!0,$("#btn_exec_flash").attr("disabled","true"),b.find(".button-previous").hide();var d={socket:null,start:function(){var a=!1,f=0;if("WebSocket"in window){var g="ws://"+location.host+"/flash_dev_socket";d.socket&&d.socket.close(),d.socket=new WebSocket(g),d.socket.onopen=function(){console.log("Opening a connection..."),d.socket.send(JSON.stringify(e))},d.socket.onclose=function(a){console.log("I'm sorry. Bye!")},d.socket.onerror=function(a){console.log("ERR: "+a.data)},d.socket.onmessage=function(e){var g=JSON.parse(e.data);console.log(g);try{if("NODE_UNAVAILABLE"in g[0]){if(!a)return d.socket.close(),$("#btn_exec_flash").removeAttr("disabled"),b.find(".button-previous").show(),hiAlert(g[0].NODE_UNAVAILABLE,"提示"),c=!1,!1}else f=i(g,d,f)}catch(a){console.log(g),console.log(a)}}}else hiAlert("你的浏览器太落伍了，换用高版本的chrome内核浏览器吧！！！","提示")}};d.start()})}})};return{init:function(){jQuery().bootstrapWizard&&jQuery().dataTable&&j()}}}();jQuery(document).ready(function(){FlashDeviceWizard.init()}),jQuery.extend({Device_Flash_Fireware_Global_Args:{GLOBAL_FILECANUPLOAD_FLAG:!1,GLOBAL_ALLFILEUPLOAD_FLAG:!1,GLOBAL_IS_FILE_UPLOAD_SUCCESS:{}}});var FormFileUpload=function(){return{init:function(){$("#fileupload").fileupload({disableImageResize:!1,autoUpload:!1,disableImageResize:/Android(?!.*Chrome)|Opera/.test(window.navigator.userAgent),maxFileSize:5e39}),$("#fileupload").fileupload("option","redirect",window.location.href.replace(/\/[^\/]*$/,"/cors/result.html?%s")),$(document).bind("keydown",function(a){var a=window.event||a;if(116==a.keyCode)return a.keyCode=0,!1}),$("#fileinput").on("click","",function(a){if($("#fileupload").find(".table")[0].rows.length>1)return hiAlert("此页面还有待处理的文件，请点击开始上传或者清空添加文件按钮，然后继续操作","提示"),$("#pulsate-once-target").pulsate({color:"#399bc3",repeat:3}),void a.preventDefault()}),$("#btnallupload").on("mousemove","",function(a){jQuery.Device_Flash_Fireware_Global_Args.GLOBAL_ALLFILEUPLOAD_FLAG=!0,jQuery.Device_Flash_Fireware_Global_Args.GLOBAL_FILECANUPLOAD_FLAG=!1}),$("#btnallupload").on("mouseout","",function(a){jQuery.Device_Flash_Fireware_Global_Args.GLOBAL_ALLFILEUPLOAD_FLAG=!1}),$("#btnallupload").on("click","",function(a){var b=$("#table_upload_file").find("tr").length-1,c=$("table").find("tr").find("span:contains(上传)").length;if(0!=b&&0!=c){jQuery.Device_Flash_Fireware_Global_Args.GLOBAL_ALLFILEUPLOAD_FLAG=!0;var d=$("#current_user_id").text(),e=d;jQuery.ajax({type:"post",url:"/getUserRightInUploadTestCase?product_id="+e+"&current_user_id="+d,async:!1,error:function(a){return hiAlert("获取产品线上传状态失败，请联系管理员","提示"),!1},success:function(a,b,f){if("0"==a){var g={};g.product_id=e,g.current_user_id=d,g.uploadtest_status=1,$.ajax({type:"post",url:"/setUserRightInUploadTestCase?product_id="+e+"&current_user_id="+d+"&uploadtest_status=1&allfileupload_count="+c,error:function(a){jQuery.Device_Flash_Fireware_Global_Args.GLOBAL_ALLFILEUPLOAD_FLAG=!1},success:function(a){jQuery.Device_Flash_Fireware_Global_Args.GLOBAL_FILECANUPLOAD_FLAG=!0,$("#btnallupload").attr("disabled","true")}})}else"1"==a&&(jQuery.Device_Flash_Fireware_Global_Args.GLOBAL_FILECANUPLOAD_FLAG=!1,hiAlert("请稍等，此产品线正在上传用例","提示"))}})}}),window.onbeforeunload=function(){var a={};a.uploadtest_status=0,a.current_user_id=$("#current_user_id").text(),a.product_id=a.current_user_id,a.remove_all=!0,$.ajax({type:"post",url:"/setUserRightInUploadTestCase",data:a,error:function(a){hiAlert("设置产品线上传状态失败")},success:function(a){}})}}}}();jQuery(document).ready(function(){FormFileUpload.init()});